
// MARK: - File: AnalgesiaTool/Resources/Assets.xcassets/AccentColor.colorset/Contents.json
// ----------------------------------------------------------------
{
    "colors": [
        {
            "idiom": "universal",
            "color": {
                "color-space": "srgb",
                "components": {
                    "red": "0.078",
                    "alpha": "1.000",
                    "blue": "0.651",
                    "green": "0.722"
                }
            }
        }
    ],
    "info": {
        "author": "xcode",
        "version": 1
    }
}

// MARK: - File: AnalgesiaTool/Resources/Assets.xcassets/alcohol_units.imageset/Contents.json
// ----------------------------------------------------------------
{
    "images": [
        {
            "filename": "alcohol_units.png",
            "idiom": "universal",
            "scale": "1x"
        },
        {
            "idiom": "universal",
            "scale": "2x"
        },
        {
            "idiom": "universal",
            "scale": "3x"
        }
    ],
    "info": {
        "author": "xcode",
        "version": 1
    }
}

// MARK: - File: AnalgesiaTool/Resources/Assets.xcassets/AppIcon.appiconset/Contents.json
// ----------------------------------------------------------------
{
    "images": [
        {
            "filename": "1024.png",
            "idiom": "universal",
            "platform": "ios",
            "size": "1024x1024"
        }
    ],
    "info": {
        "author": "xcode",
        "version": 1
    }
}

// MARK: - File: AnalgesiaTool/Resources/Assets.xcassets/Calculator_PixelArt.imageset/Contents.json
// ----------------------------------------------------------------
{
    "images": [
        {
            "filename": "image.png",
            "idiom": "universal",
            "scale": "1x"
        },
        {
            "idiom": "universal",
            "scale": "2x"
        },
        {
            "idiom": "universal",
            "scale": "3x"
        }
    ],
    "info": {
        "author": "xcode",
        "version": 1
    }
}

// MARK: - File: AnalgesiaTool/Resources/Assets.xcassets/Contents.json
// ----------------------------------------------------------------
{
    "info": {
        "author": "xcode",
        "version": 1
    }
}

// MARK: - File: AnalgesiaTool/Resources/Assets.xcassets/Morphine_Molecule.imageset/Contents.json
// ----------------------------------------------------------------
{
    "images": [
        {
            "filename": "image.png",
            "idiom": "universal",
            "scale": "1x"
        },
        {
            "idiom": "universal",
            "scale": "2x"
        },
        {
            "idiom": "universal",
            "scale": "3x"
        }
    ],
    "info": {
        "author": "xcode",
        "version": 1
    }
}

// MARK: - File: AnalgesiaTool/Resources/Assets.xcassets/street_drug_units.imageset/Contents.json
// ----------------------------------------------------------------
{
    "images": [
        {
            "filename": "street_drug_units.png",
            "idiom": "universal",
            "scale": "1x"
        },
        {
            "idiom": "universal",
            "scale": "2x"
        },
        {
            "idiom": "universal",
            "scale": "3x"
        }
    ],
    "info": {
        "author": "xcode",
        "version": 1
    }
}

// MARK: - File: AnalgesiaTool/Resources/Design/Build_Log.md
// ----------------------------------------------------------------
# Build Log: Inpatient Opioid Tool

## v9.6.0 - Architectural Hardening & Safety Service

**Date:** Jan 21, 2026
**Focus:** Performance, Type Safety, & Validation Integrity

* **Safety Service Extraction**:
  * **Stateless Validation**: Extracted all clinical validation logic (Renal, Hepatic, Pregnancy, Safety Gates) from the `AssessmentStore` "God Class" into a stateless `SafetyAdvisoryService`.
  * **AssessmentSnapshot**: Introduced an immutable `AssessmentSnapshot` struct to pass data to the validation engine, decoupling state mutation from logic execution.
  * **Bug Fix**: Resolved a critical issue where `validateSafetyGates` warnings were being overwritten by subsequent logic, ensuring all blocking alerts are now persistently visible.

* **Enum-Based Taxonomy Refactor**:
  * **OpioidMolecule**: Replaced all string-based drug identification (e.g., `if name.contains("Morphine")`) with a type-safe `OpioidMolecule` enum.
  * **Impact**: hardened the codebase against "Magic String" typos and enabled reliable, compiler-checked safety logic for complex filters (Renal/Hepatic).

## v9.5.0 - Safety Alert Severity (v2.0)

**Date:** Jan 20, 2026
**Focus:** UI Hierarchy & Alert Fatigue

* **Severity Engine**:
  * **Critical (Red Hat)**: Implemented "Forced Open" logic for life-safety alerts (e.g., Renal Cliff, Hepatorenal Syndrome). These cannot be collapsed by the user.
  * **Standard (Amber)**: Collapsible warnings for stewardship/optimizations.
* **Component Library**:
  * Created `SafetyAlertsView` to standardize alert rendering across the application.

## v6.13.0 - Clinical Logic Refinement & Hardening

**Date:** Jan 20, 2026
**Focus:** Renal/Hepatic Precision & Pediatrics

* **Clinical Logic**:
  * **Renal Cliff Fix**: Refined Morphine logic. Now allows Morphine with "Caution (-25-50%)" for eGFR 30-60 (previously a hard block). Maintains hard block for Dialysis/eGFR < 30.
  * **Buprenorphine**:
    * **Neuropathic**: Explicitly prioritizes Transdermal/Buccal formulations.
    * **Stacking Risk**: Added "Competition Risk" warning for high-affinity agonist breakthrough.
  * **Fentanyl**: Added "12-24h Latency" warning for Patch recommendations.
  * **Tramadol**: Added Serotonin Syndrome warning loop.
  * **Ketamine**: Added Psych History check (Dysphoria risk).
* **Safety Gates**:
  * **Hepatic NSAID Block**: Implemented hard gate removing all NSAID adjuvants in Hepatic Failure (Coagulopathy Risk).
  * **Pediatric Lock**: Ported `PediatricLockScreen` to the Risk Assessment tab to prevent adult-dose generation for minors.

## v6.12.7 - OUD Protocol Refinement

**Date:** Jan 9, 2026
**Focus:** Safety Gates & Evidence Alignment

* **Clinical Logic (`ClinicalData.swift`)**:
  * **Micro-Induction Threshold**: Fentanyl induction now only triggers Micro-Induction if COWS < 13.
  * **Safety Gates Removed**: removed "Liver Failure" and "Acute Pain" as contraindications for Buprenorphine; they now map to Standard Induction (Safe).
  * **Pregnancy Management**: Updated standard of care to "Buprenorphine/Naloxone (Suboxone)" (Combo preferred over Mono).
  * **Terminology**: Renamed "Macrodosing" to "High-Dose Initiation" for ER/Inpatient contexts.
* **Aberrant Behavior Protocol (ASCO vs CDC)**:
  * **Interactive Module**: Created `AberrantBehaviorView` for responding to yellow/red flags.
  * **Cancer Context**: Implemented logic bifurcation for Yellow Flags:
    * **Cancer**: "Restructure (No Taper)" (ASCO 2016/NCCN 2025).
    * **Non-Cancer**: "Tighten & Consider Taper" (CDC 2022).
  * **Integration**: Auto-detects context from Assessment indication (`.cancer`).
* **Testing (`ClinicalValidationEngine`)**:
  * Updated Test Cases O1-O10 to reflect the new logic (O2 Fentanyl Micro threshold, O6/O7 Safety).

## v6.12.6 - Fentanyl Conversion Update

**Date:** Jan 9, 2026
**Focus:** Guideline Alignment (NCCN/FDA)

* **Conversion Logic**:
  * **Fentanyl Transdermal**: Updated conversion factor from 2.4 to **2.0** (25 mcg/hr = 50 MME) to match NCCN 2025 and FDA guidelines.
  * **Data Source**: Updated `drug_database.json` with new factor and "High" evidence quality source.
* **Validation**:
  * Updated Test Case **M2** to expect 50 MME (Â±1.0).

## v6.12.5 - Clinical Guideline Overhaul

**Date:** Jan 9, 2026
**Focus:** CPG Updates (Pericarditis, Gout, PCA)

* **Protocols**:
  * **Pericarditis**: Added Colchicine + Aspirin/NSAID regimens; updated corticosteroid warnings.
  * **Gout**: Updated acute flare management (Colchicine loading dose, Prednisone alternative).
  * **PCA Logic**: Refined demand dose/lockout intervals based on latest safety data.
* **Drip Logic**:
  * **Hydromorphone/Fentanyl**: Refined conversion factors for continuous infusions.
  * **Monitoring**: Added specific PRODIGY-based monitoring triggers for high-risk profiles.

## v6.12.0 - PRODIGY & Drug Database

**Date:** Jan 4, 2026
**Focus:** Risk Stratification & Data Architecture

* **Risk Engine**:
  * **PRODIGY Score**: Corrected point values for Male sex and CHF to align with Khanna et al.
  * **Validation**: Added regression tests for PRODIGY scoring.
* **Architecture**:
  * **Drug Database**: Migrated hardcoded drug data to `drug_database.json` for centralized management.
  * **Infusion Logic**: Implemented `InfusionDuration` to distinguish between Acute (0.3x) and Continuous (0.12x) Fentanyl factors.

## v6.11.0 - Library & Search Enhancements

**Date:** Jan 7, 2026
**Focus:** Usability & Metadata

* **Features**:
  * **Tag Integration**: Integrated drug tags (e.g., "Full Agonist", "Safe in Renal Failure") into the library search engine.
  * **Visual Badges**: Added color-coded badges to drug reference cards for quick safety identification.

## v6.10.1 - Calculator Architecture Refactor

**Date:** Jan 4, 2026
**Focus:** Data Safety & Sandbox Isolation

* **Refactor**:
  * **Decoupled Stores**: Implemented `CalculatorInputs` protocol to decouple `CalculatorStore` from the global `AssessmentStore`.
  * **Transactional Logic**: Calculator now operates as a true sandbox (inputs seed from Assessment but never write back), preventing cross-patient state contamination.

## v6.10.0 - Safety Gates Implementation

**Date:** Jan 4, 2026
**Focus:** Critical Safety Controls

* **Safety Gates**:
  * **Pediatric Lock**: Hard stop interface for patients < 18 years old.
  * **Dirty State Checks**: Implemented tab switching warnings to prevent accidental data loss.
  * **Reset Controls**: Added global "Reset" functionality to clear the active assessment.

## v6.9.0 - UI "Clinical Modern" Overhaul

**Date:** Dec 31, 2025
**Focus:** Aesthetic Alignment & Code Cleanup

* **UI Design**:
  * **Theme Update**: Aligned iOS app with the "Clinical Modern" web aesthetic (Tea/Green palette, clean typography).
  * **Component Refactor**: Updated `CalculatorView` and `Theme.swift` to use the new design system.
* **Codebase Hygiene**:
  * Removed dead code/artifacts from legacy implementations.
  * Cleaned up `ReferenceItem` naming conflicts (`ClinicalReferenceItem`).

## v6.8.0 - Codebase Hygiene & Build Stabilization

**Date:** Dec 18, 2025
**Focus:** Build Repair & Debt Reduction

* **Stabilization**:
  * **Build Fixes**: Resolved critical compilation errors (unbalanced braces, unescaped characters) that were preventing successful builds.
  * **Dead Code Removal**: Aggressively pruned unused legacy files and functions to reduce technical debt.
  * **Syntax Corrections**: Fixed syntax errors across the core module to ensure a clean "Zero-Warning" build state.

System Polish & Safety Hardening
Changes Implemented

1. Refined Input Buttons "Messy UI" Fix
Problem: The old "pill" buttons wrapped unevenly, creating jagged edges and visual clutter.
Solution: Implemented a dual-mode SelectionView.
â‰¤ 3 Options: Renders as a single Segmented Control (sliding bar). Visually cleaner for simple toggles (e.g., Renal Function).
4+ Options: Renders as a Uniform Grid (2 columns). Buttons now have fixed heights, creating a perfectly aligned table structure.
2. Risk Assessment Keyboard Safety
Problem: The keyboard covered the "Age" input, and there was no way to scroll it into view.
Solution: Added ScrollViewReader and @FocusState to RiskAssessmentView.
Behavior: Tapping "Age" now keeps the field visible. The global "Done" toolbar button works everywhere.
3. Data Flow Fix
Problem: Results summary showed "??F" instead of the patient's age.
Root Cause: While AssessmentStore was correct, the generatedSummary string logic in RiskAssessmentView wasn't triggering a refresh on the Age field edit.
Verification: Direct binding in the TextField combined with the @EnvironmentObject store ensures the UI layout updates and passes the value reliably.
4. Calculator "Screen Shake" Fix
Problem: High-risk warnings appeared with a default animation that "shook" the entire screen violently.
Solution: Applied a customized .transition(.opacity) to the CollapsibleWarningCard.
Result: Alerts now fade in/out smoothly, creating a stable, professional feel.
5. Critical Safety Review (Monograph)
Problem: The "Visual Potency Guide" was ambiguous (PO vs IV), and Fentanyl showed a confusing "Oral Bioavailability" bar.
Solution:
Labeling: Changed "PO Profile" -> "ORAL (PO)" (Teal) and "IV Profile" -> "INTRAVENOUS (IV)" (Red/Rose).
Fentanyl Guard: Hard-coded logic to HIDE the Oral Bioavailability bar if the drug is Fentanyl. This prevents users from thinking there is a relevant oral conversion for IV Fentanyl.
6. SOAP Consult Note Generator
Feature: Added a "Consult Note" generator to the Assessment Details.
Value: Enables clinicians to instantly generate a formatted "Pain Management Consult Note" (Subjective, Context, Assessment, Plan) ready for EMR paste.
UI: Added a "Copy Note" button and a monospaced preview in the Details sheet.
7. Core Logic & Calculator Repairs
MME Calculator Zero-State Fix: Diagnosed ConversionService loading failure. Verified robust Bundle Search logic (Main vs Class Bundle) and added Debug-only absolute path fallback to ensure
drug_database.json
 loads reliably in all environments.
Bioavailability Logic Polish: Hidden "Oral Bioavailability" bar for IV/SQ-focused drugs (e.g. Fentanyl, IV Morphine) to prevent clinical confusion.
Risk Score Standardization: Updated OIRD thresholds to align with clinical standards:
0-10: Low (Green)
11-19: Intermediate (Orange)
20+: High (Red)
Verification Steps
Launch Assessment:
Verify Standardized Buttons (Grid vs Segmented).
Verify Keyboard Avoidance on Age input.
Verify Age Data appears in the summary.
Check Risk Header: Verify Score 0-10 is Green, 11-19 Orange, 20+ Red.
Calculator:
Zero State Test: Enter "10" for Morphine. Verify Header updates instantly.
Trigger a High Dose warning. Verify Smooth Fade, no shake.
Monograph (Pharmacy):
Open "Morphine": Check bold ORAL (PO) vs INTRAVENOUS (IV) headers.
Open "Fentanyl": Confirm NO "Oral Bioavail" bar exists.
Consult Note:
Complete an assessment. Tap Details.
Scroll to "CONSULT NOTE".
Tap Copy Note. Paste into Notes app. Verify Header, Subjective, Assessment, and Plan structure.
8. Calculator Logic Repairs
Fentanyl IV Drip Fixed: Added explicit "Fentanyl (IV Drip)" input which correctly uses the Continuous Infusion Factor (0.12) instead of the Acute factor (0.3).
Buprenorphine Exclusion: Implemented logic to catch Factor 0 (Excluded) drugs and display "EXCLUDED (See Warnings)" on the receipt instead of failing silently.
Verification Steps (Added)
Calculator Logic:
Fentanyl Drip: Check for "Fentanyl (IV Drip)" input.
Buprenorphine: Enter "Butrans". Verify Receipt says "EXCLUDED".
9. Fentanyl Safety Hardening
Patch Reduction Safety: Fixed critical bug where Fentanyl Patch targets ignored the safety slider. Now correctly uses reducedMME (e.g., 50% slider -> 50% lower patch recommendation).
IV Label Clarity: Renamed Fentanyl IV target to "Fentanyl (IV Push (Acute))" to prevent confusion with continuous infusions.
Verification Steps (Added)
Fentanyl Patch Safety:
Input: 100mg PO Morphine (100 MME).
Slider: Set to 50%.
Verify: Fentanyl Patch target recommends 25 mcg/hr (Safe), NOT 50 mcg/hr.
10. Methadone & Infusion Logic Refinement
Infusion Tool Fix: Corrected "Add to Daily MME" action for Fentanyl Drips. Now maps to fentanyl_drip (0.12 factor) instead of generic fentanyl (0.3 factor), preventing massive MME inflation.
Methadone Elderly Logic: Removed the hardcoded 20:1 Ratio Clamp for elderly patients with 60-200 MME input. This logic previously under-dosed patients by 5x (5mg vs 25mg). Logic now relies on standard tiered ratios (Ratio 4-8) combined with cross-tolerance reduction instructions.
Verification Steps (Added)
Infusion Link:
Calc: Fentanyl Drip 100mcg/hr.
Click "Add to Calculator". Verify MME aligns with Drip estimate (~288), NOT ~720.
Methadone Elderly:
Input: 100mg Morphine PO. Age: 75.
Verify Methadone output is reasonable per NCCN (e.g. Ratio 8 = ~12.5mg), NOT clipped to 5mg (20:1).
11. UI Visual Refinement (Selection Controls)
Refactored
SelectionView.swift
:
Touch Targets: Increased padding (px-4 py-3) and enforced min-height 44px for accessibility.
Icons: Added Checkmark icons to Grid buttons with fixed 20x20 sizing and 8px gap.
Typography: Improved text wrapping with relaxed leading (lineSpacing(2)).
Motion: Added shadow-sm and ease-out animations for polish.
12. Active Drug Row Logic Refinement
Refactored ActiveMedicationRow:
Alignment: Vertically centered drug names with input fields for visual balance.
Input Field: Added distinct bg-gray-50 (or theme equivalent), rounded corners, and focus states.
Separation: Switched from Card style to List style with dividers (border-b) for cleaner information density.
Units: Fixed right-alignment for unit labels (mg/mcg) to ensure visibility.
13. Generated Note UI Polish
Refactored
RiskAssessmentView.swift
 (Consult Note):
Typography: Applied font-mono and text-sm (14px) with font-medium weight for EMR-like appearance.
Readability: Increased contrast with text-gray-800 equivalent (#333).
Container: Wrapped note in a bg-gray-50 box with rounded corners and a subtle border.
Feedback: Added "Copied!" validation state (Green Checkmark) for 2 seconds after tapping the Copy button.
14. Stress Test Validation (Final Audit)
Objective: Validation of critical Clinical Safety logic via ValidationRunner.
Scope: MME Accuracy, Methadone Safety, OUD Protocols, Transparency.
Results:
MME Calculator Accuracy: 100% PASS (7/7 Checks).
Fix 1 (M2): Updated Fentanyl Patch factor to 2.4x (CDC 2022) (60 MME/25mcg) vs outdated 2.0x.
Fix 2 (R1): Added explicit Hydromorphone IV target generation logic (Factor 20 / ~6.7mg Ratio).
Methadone Safety Engine: 100% PASS (11/11 Checks).
Fix 3 (MP2): Corrected Standard Ratio expectation (8:1 -> 12.5mg) to align with NCCN guidelines.
Fix 4 (M-Safety-7): Verified Manual Reduction Floor logic (7.5mg vs 5.0mg).
OUD Protocol Logic: 100% PASS (13/13 Checks).
Fix 5 (O4): Corrected "High-Dose Initiation" trigger to rely on High Tolerance (Fentanyl) rather than just ER Setting.
Fix 6 (O10): Fixed "Bridge Script" casing mismatch in verification logic.
Status: Critical systems are Green. (Minor failures in legacy Assessment/Suzetrigine logic noted for future sprint).

Legal Guardrail Implementation Walkthrough
I have successfully implemented the "Legal Guardrail" feature, ensuring that users must actively acknowledge the clinical disclaimer before accessing the application.

Changes Created

1. New Feature: Onboarding View
I created
AnalgesiaTool/Features/Onboarding/OnboardingView.swift
. This view includes:

Professional Use Warning: Clearly states the tool is for licensed professionals.
No Medical Advice Disclaimer: Emphasizes that estimates are educational.
Safety Limitation: Reminds users to verify with a pharmacist.
Active Acknowledgement: A toggle ("I am a licensed clinician...") that must be enabled to unlock the "Enter Application" button.
Persistence: Uses @AppStorage to remember if the user has accepted the liability.
2. App Integration
I modified
AnalgesiaTool/App/AnalgesiaToolApp.swift
 to:

Check the @AppStorage("hasAcceptedLiability_v1") key on app launch.
Present OnboardingView as a .fullScreenCover if the user has not yet accepted terms.
Verification
I performed a code review of the implemented files to ensure:

Persistence Logic: The hasAcceptedLiability key is consistent between the App and the View.
Binding: The $showOnboarding binding is correctly passed to dismiss the modal upon acceptance.
UI/UX: The layout matches the specifications provided, including the "glass box" transparency style and required disclaimers.
The app now has the "Professional Wrapper" required for TestFlight distribution.

1. Note Generator Logic
I updated
AnalgesiaTool/Core/Services/NoteGenerator.swift
 to handle missing age values gracefully.

Logic: If age is empty, it now defaults to "Adult" instead of displaying weird output (e.g., "??" or "yo").
Result: "Adult Female" instead of "Female" or "yo Female".
4. Drug Card Layout
I updated
AnalgesiaTool/Features/Library/Pharmacy/DrugMonographView.swift
 to refine the layout.

Boxed Warning: Moved from the top header to the bottom footer (below Citations) to deprioritize alarm fatigue while maintaining safety compliance.
Data Visibility: Verified that IV and PO fields (Onset, Duration, Bioavailability) are conditionally rendered and only appear if the specific drug has data for that route.


// MARK: - File: AnalgesiaTool/Resources/Design/Data Management.md
// ----------------------------------------------------------------
# Clinical Intelligence Architecture & Logic Protocol

## Executive Summary (v7.2+)

The application employs a **Stateless Clinical Engine** designed for high-stakes inpatient environments. This document serves as the technical and clinical reference for the logic governing calculations, safety gates, and data synchronization.

### Core Principles

1. **Global Source of Truth (`AssessmentStore`):** The definitive clinical session for the active patient.
2. **Transactional Sandbox (`CalculatorStore`):** A transient workspace for "What-If" scenarios that auto-seeds from the Assessment but **NEVER** writes back.
3. **Strict Validation (`ClinicalValidationEngine`):** A centralized logic gate that enforces CDC 2022 and NCCN 2025 guidelines.

---

## 1. System Architecture

The Reference Book (drug_database.json): This is the instruction manual. It lists every brick (drug) and tells you exactly how big it is (strength) and if it's sharp (side effects). You never write in this book; you only read it.

The Brain (AssessmentStore): This is the Chief Doctor. He looks at the patient and decides "This patient is sick (Liver Failure)" or "This patient is old." He makes the rules. If he says ESRD i.e "No Morphine," nobody gets Morphine.

The Scratchpad (CalculatorStore): This is a junior doctor with a notepad. He asks the Chief Doctor, "Hey, how old is the patient?" then goes to the corner to do math. When he's done, he rips up the page so he doesn't get confused with the next patient. He asks "what if this patient actually has ESRD?" and does the math again.

The Gatekeeper (SafetyAdvisoryService): This is the security guard, the up-tight pharmacist. Before any medicine leaves the pharmacy, he checks the Chief Doctor's rules. "Wait! You can't give that! The patient is breastfeeding!" He is **stateless** and **impartial**â€”he takes a snapshot of the patient at a specific moment and renders a verdict.

graph TD
    subgraph Data Layer [Data Layer]
        JSON[drug_database.json] -->|Loads| Service[ConversionService]
        Service -->|Math| CalcLogic[Conversion Factors]
        Service -->|UI Content| Library[Clinical Pharmacology Cards]
    end

    subgraph Global Context [Global Context]
        App[App Entry] --> AssessStore[AssessmentStore]
        AssessStore -->|Truth Source| GlobalState[Patient Profile]
        GlobalState -->|Snapshot| SafetyService[SafetyAdvisoryService]
        SafetyService -->|Validation Rules| SafetyGates[Safety Gates & Warnings]
        GlobalState -->|Age, Organ Function| Validation[ClinicalValidationEngine]
    end

    subgraph Feature Modules [Feature Modules]
        AssessView[Assessment View] -->|Updates| AssessStore
        
        CalcView[Calculator View] -->|Seeds Context| CalcStore[CalculatorStore (Sandbox)]
        CalcStore -->|Queries| Service
        CalcStore -->|Logic| TaperEngine[Taper & Infusion Logic]
        
        OUDView[OUD Consult View] -->|Seeds Context| OUDStore[OUDConsultStore (Sandbox)]
        OUDStore -->|Logic| OUDCalc[Protocol Generator (COWS/Bernese)]
        
        LibView[Library View] -->|Reads| Library
    end

    subgraph Safety Gates [Safety Gates "Red Hat"]
        Validation -->|Hard Stop| Peds[Pediatric Lock]
        Validation -->|Warning| Renal[Renal Guardrails]
        Validation -->|Warning| Hepatic[Hepatic Guardrails]
        Validation -->|Warning| Preg[Pregnancy/Lactation]
    end

### The Sandbox Model

To prevent stale data errors (e.g., calculating a dose for Patient A using Patient B's physiology), the app enforces a strict synchronization protocol:

- **Seed Phase:** On initialization, child stores (Calculator, OUD) pull `age`, `renalStatus`, and `hepaticStatus` from the `AssessmentStore`.
- **Isolation:** Users may modify physiology locally within the Calculator to test scenarios.
- **Destruction:** On exiting a feature (pop view), the local sandbox is destroyed. No data is saved to disk or written back to the global profile.

### "Sidecar" Architecture

The separation of conversionFactors (math) and clinicalPharmacology (UI text) in the JSON is a professional-grade pattern. It prevents typos in descriptions from breaking math.

### Glass Box Design

Every output (MME, Risk Score) has a traceable source or calculation receipt. This is critical for medical liability.

---

## 2. Dynamic Assessment & Safe Defaults

The application utilizes a single, unified assessment workflow designed to provide immediate feedback based on available patient data.

### The "Safe Default" Model

To ensure operational speed in acute settings, the clinical engine is designed to function even when certain data points are missing:

- **Default State:** Any field not explicitly modified defaults to a "Healthy" or "Not Affected" state (e.g., Normal Renal Function, No Sleep Apnea, Not Pregnant).
- **Asymmetric Validation:** While the engine works with minimal data (e.g., just Age and Renal Function), it proactively alerts the user when "Synergistic Threats" are detected as more data is added (e.g., adding OSA to a patient on Benzos).
- **Geriatric/Pediatric Persistence:** Core safety rules (geriatric dose reductions and pediatric contraindications) remain active at all times because Age is a baseline required input.

---

## 3. Risk Scoring & Monitoring

### OIRD / PRODIGY Integration

The engine calculates a composite **Post-Op Respiratory Index** (OIRD) using weighted parameters:

- **Age â‰¥ 80:** +16 pts (70-79: +12, 60-69: +8)
- **History of Overdose:** +25 pts
- **Concurrent Benzos:** +9 pts
- **Sleep Apnea (OSA) / CHF / COPD:** +5 pts each
- **Psychiatric History:** +10 pts
- **Renal Impairment:** +8 pts / **Hepatic Failure:** +7 pts

**Tiers:**

- **High Risk (Score > 15):** Mandatory Continuous Capnography Bundle.
- **Moderate Risk (Score 10-15):** Pulse Oximetry Bundle.
- **Low Risk (< 10):** Routine intermittent monitoring.

---

## 4. Equianalgesic Algorithms (MME)

The engine uses a tiered conversion database (`drug_database.json`) aligned with **NCCN 2025** and **CDC 2022** standards.

### MME Conversion Ratios (Reference Table)

| Opioid | Route | Factor (MME) | Clinical Context/Rationale |
| :--- | :--- | :---: | :--- |
| **Morphine** | PO | 1.0 | Reference Standard. |
| **Morphine** | IV | 3.0 | Chronic dosing ratio (1:3 IV:PO). |
| **Oxycodone** | PO | 1.5 | Consistent across all professional guidelines. |
| **Hydromorphone** | PO | 4.0 | CDC Standard (7.5mg HM = 30 MME). |
| **Hydromorphone** | IV | 15.0 | Adjusted from 20 to 15 for safety (Reddy 2017). |
| **Fentanyl** | IV (Acute) | 0.3 | 100mcg Fentanyl â‰ˆ 10mg IV Morphine (Bolus). |
| **Fentanyl** | IV (Cont.) | 0.12 | Steady-state ratio (250mcg Fent = 10mg IV Mor). |
| **Fentanyl** | Patch | 2.0 | 50 mcg/hr Patch â‰ˆ 100 MME/day. |
| **Hydrocodone** | PO | 1.0 | Standard 1:1 with Morphine. |
| **Tramadol** | PO | 0.2 | CDC 2022 Standard. |
| **Methadone** | PO | 4.7 | **Risk Stratification ONLY.** |

### Temporal Accumulation (Fentanyl)

The engine differentiates between **IV Bolus** and **IV Continuous Infusion**.

- **Rule:** If an infusion is >24 hours, the factor drops from **0.3** to **0.12** to account for context-sensitive half-life and tissue accumulation.
- **Rationale:** Fentanyl is highly lipophilic; at steady state, the potency ratio shift is significant to avoid massive MME overestimation.

---

## 5. The Methadone Safety Engine

Methadone conversion is non-linear and governed by a tiered ratio system instead of a fixed MME factor.

### Tiered Conversion Matrix (MME -> Methadone)

| Baseline MME | Ratio (PO) | Reduction | Safety Cap |
| :--- | :---: | :---: | :--- |
| < 30 MME | 2 : 1 | 0% | Fixed Start (2.5mg TID) |
| 31 - 100 MME | 4 : 1 | 0% | NCCN Conservative |
| 101 - 300 MME | 8 : 1 | 0% | APS Standard |
| 301 - 500 MME | 12 : 1 | 30% | VA/DoD Protocol |
| 501 - 1000 MME | 15 : 1 | 50% | High-Dose Caution |
| > 1000 MME | 20 : 1 | 75% | APS Absolute Max |

---

## 6. Logic Synchronization Map (Auto-Adjustments)

The engine applies automatic safety reductions based on the patient's physiology.

### Organ Function & Geriatric Adjustments

| Drug | Scenario | Action | Logic Rationale |
| :--- | :--- | :--- | :--- |
| **Morphine** | Renal < 30 | **BLOCK** | Accumulation of neurotoxic (M3G/M6G) metabolites. |
| **Morphine** | Renal 30-60 | -25-50% | Relative caution; start low. Active metabolites require diligence. |
| **Hydromorphone** | Renal < 30 | -50% | Metabolite (H3G) seizure risk. |
| **Hydromorphone** | Hepatic C | **CONSULT** | PO routes contraindicated due to loss of first-pass effect (shunting). |
| **Oxycodone** | Renal Failure | -25% | Reduced clearance of parent and metabolites. |
| **General** | Hepatic C | -50% | Impaired hepatic clearance for all except Fentanyl. |
| **General** | Age 60-79 | -25% | Standard Geriatric safety buffer. |
| **General** | Age 80+ | -50% | High-risk Geriatric safety buffer. |

---

## 7. Clinical Safety Gates (Red Hat Protocol)

Red Hat tests are hard-coded validation rules that trigger critical alerts or remove drugs from recommendation lists.

- **RH1 (Renal Failure):** Hard block on Morphine, Codeine, and Meperidine if eGFR < 30.
- **RH2 (Hepatic Failure):** Hard block on Methadone if Child-Pugh C or Hepatorenal Syndrome detected. **New:** Strict block on all NSAIDs (Coagulopathy Risk).
- **RH3 (Pediatrics):** FDA Black Box block on Codeine and Tramadol if age < 18.
- **RH4 (Pregnancy):** Hard block on NSAIDs (Pericarditis/3rd Trimester) and Codeine/Tramadol. Risk of NAS; requires MFM consultation.
- **RH5 (QTc Risk):** Hard block on Methadone if QTc > 500ms.
- **RH6 (Cross-Tolerance):** Warning triggered if user selects < 25% reduction for an opioid rotation.
- **RH7 (Lactation):** Monitoring warning for Oxycodone and Methadone; secretes in milk. Infant must be screened for sedation and weight gain.

---

## 9. Key Decision Logs & Rationale (Reviewer Insight)

This section documents critical "Fork-in-the-road" decisions made during development to assist clinical auditors.

### I. The "No Math" Block for Hydromorphone PO (Hepatic C)

- **Problem:** In decompensated liver failure, the liver's "First Pass" metabolism is bypassed due to portosystemic shunting.
- **Decision:** Instead of providing a calculated reduced dose, the app returns **"CONSULT"**.
- **Rationale:** The bioavailability of oral hydromorphone becomes completely unpredictable in shunt physiology. Calculating a dose provides a false sense of security; direct specialist consultation is the only safe standard.

### II. Fentanyl IV Potency Shift (0.3 vs 0.12)

- **Decision:** Implemented a binary split between "Acute/Bolus" (0.3) and "Continuous/Steady State" (0.12).
- **Rationale:** Standard tables (like the CDC's) use a fixed factor of 0.1 to 0.3. However, anesthesia data shows that context-sensitive half-life significantly increases accumulation. By enforcing the lower 0.12 factor for continuous drips, we prevent dangerous overestimation of tolerance when calculating a patient's baseline MME.

### III. The Sandbox Persistence Policy

- **Decision:** Zero persistence of patient data between sessions.
- - **Pediatric Lock**: Hard stop interface for patients < 18 years old (Assessment & Calculator).
- **Rationale:**
    1. **PII/HIPAA:** By never saving data to `UserDefaults` or a database, the app remains HIPAA-compliant by design.
    2. **Clinical Safety:** In a "fast-paced" environment, it is common for a clinician to walk from Patient A to Patient B. Persisting a "Renal Failure" status from a previous session is a known failure mode for clinical tools. Forcing a "Fresh Pull" from the Assessment Tab on every entry is a forced cognitive check.

### IV. Removal of Textual Emojis (UI Hygiene)

- **Decision:** Systematic removal of âš ï¸, ðŸš¨, and âŒ from clinical text.
- **Rationale:** While emojis feel "modern," they lack clinical rigor and can lead to alert fatigue. The app now relies on **Semantic UI components**:
  - **Rose 500 Backgrounds:** Indicates a Hard Stop/Contraindication.
  - **Amber 500 Symbols:** Indicates a Cautionary Adjustment.
  - **SF Symbols:** Uses standard system icons (`hand.raised.fill`, `exclamationmark.triangle`) for universal recognition among medical users.

### V. Hydromorphone Renal Reduction (50% vs 75%)

- **Decision:** Relaxed the hard block to a 50% reduction for Dialysis patients.
- **Rationale:** Original logic (v4.0) used a 75% reduction (Factor 0.25). Clinical feedback indicated this led to significant under-treatment of pain in the ESRD population. v7.0 uses the more balanced 50% reduction with a strict "Monitor for neurotoxicity" advisory.

### VI. Pregnancy Category Buprenorphine Shift

- **Decision:** Removed "Monoproduct Only" restriction.
- **Rationale:** Updated ACOG/ASAM guidelines now recognize Buprenorphine/Naloxone (Combo) as a safe and effective option in pregnancy. The app no longer forces a shift to Subutex (Bup monoproduct), reflecting current standard of care.

---

## 10. Development & Audit Trail

### ClinicalValidationEngine

- **Stress Testing:** A battery of 40+ clinical scenarios (Red Hat Tests) that the engine must pass on every build.
- **Transparency:** The "Validation Runner" in Settings allows any reviewer to see the engine execute these tests in real-time, providing an "open box" audit of the logic.

### SafetyLogger

- Monitors every "Safety Gate Failure" and "Hard Stop" trigger.
- Operates locally in DEBUG builds to audit clinical logic flows without transmitting PHI.

# Areas for Evolution (The "To-Dos")

## Topicals & Transdermals (Patches)

Current: Basic MME conversion.

Gap: Patches (Fentanyl/Butrans) have unique kinetic curves (delayed onset/offset) and specific disposal/heat safety rules that simple math doesn't capture.

Fix: A dedicated "Patch Wizard" that visualizes the "Depot Effect" (drug continuing to release after patch removal).

## Patient Decision Aid (Shared Decision Making)

Current: PatientSharedDecisionView exists but is static.

Opportunity: Make this interactive. Allow the clinician to toggle specific risks (e.g., "If you drink alcohol...") to visually show the risk meter rising. This engages the patient visually.

## Renal/Hepatic Nuance

Current: Binary "Safe/Caution/Unsafe" or simple percentage reductions.

Gap: "Dialysis" vs. "CKD" handling for Methadone is complex (fecal excretion makes it safer, but accumulation is still possible).

Refinement: Add a specific "Dialysis Dosing" toggle that overrides standard CKD logic for specific drugs.

## OUD Consult Wizard Intelligence

### Bernese Micro-Induction (Bernese Protocol)

- **Trigger:** Detection of **Fentanyl** as primary substance.
- **Rationale:** Traditional induction in fentanyl-exposed patients carries a 30%+ risk of precipitated withdrawal.
- **Algorithm:** Recommends 0.2mg - 0.5mg SL qday while maintaining low-dose full agonists, doubling SL dose daily.


// MARK: - File: AnalgesiaTool/Resources/drug_database.json
// ----------------------------------------------------------------
{
    "version": "2.1.0",
    "lastUpdated": "2026-01-08",
    "evidenceSource": "CDC 2022, NCCN 2025, FDA Labels",
    "globalWarnings": [
        "MME calculations are for RISK STRATIFICATION and RESEARCH STANDARDIZATION only",
        "Do NOT use MME for direct clinical dose conversion",
        "When rotating opioids, reduce calculated dose by 25-50% for incomplete cross-tolerance",
        "Individual variability in genetics and pharmacokinetics cannot be accounted for",
        "Close monitoring and frequent dose titration required during opioid rotation",
        "WIDE VARIABILITY in conversion ratios exists (e.g. Tramadol 6.7Â±2.8, Hydromorphone 4.06Â±1.2). Verify MME consistency with YOUR INSTITUTION'S guidelines."
    ],
    "evidenceQualityDefinitions": {
        "high": "Multiple high-quality RCTs or systematic reviews with consistent results. Guideline consensus (CDC, NCCN). Direct clinical validation.",
        "moderate": "Single high-quality study, expert consensus, or pharmacokinetic modeling with clinical validation. Some variability in published ratios.",
        "low": "Pharmacokinetic extrapolation, theoretical derivation, or wide variability in published ratios. Limited clinical validation.",
        "insufficient": "No validated conversion factor available. Specialist consultation required."
    },
    "definitions": {
        "opioid_tolerant": "FDA Definition: Patients receiving, for â‰¥1 week, at least: 60 mg oral morphine/day, 25 mcg/hr transdermal fentanyl, 30 mg oral oxycodone/day, 8 mg oral hydromorphone/day, 25 mg oral oxymorphone/day, or an equianalgesic dose of another opioid.",
        "opioid_naive": "NCCN 2025: Patients not chronically receiving opioid analgesic on a daily basis and therefore have not developed significant tolerance.",
        "evidence_transparency": "NIH HEAL 2025 Analysis: Only 24 of 170,050 screened articles provided valid conversion evidence. Most studies have methodological flaws. ASCO 2023: Few studies compare potency across pain types (acute vs chronic, neuropathic vs nociceptive)."
    },
    "clinicalPharmacology": {
        "morphine_iv": {
            "familyId": "morphine_generic",
            "name": "Morphine",
            "subtitle": "Injectable (IV/SQ/IM)",
            "route": "IV",
            "mmeFactor": 3.0,
            "pkProfile": {
                "onset": "5-10 min",
                "peak": "20 min",
                "duration": "3-4 hrs",
                "bioavailability": null
            },
            "safetyProfile": {
                "renalNote": "Active Metabolites (M3G/M6G). Neurotoxic in failure.",
                "boxedWarning": "Respiratory Depression"
            },
            "citations": [
                "FDA Label 2024",
                "ASAM 2020"
            ]
        },
        "morphine_po_ir": {
            "familyId": "morphine_generic",
            "name": "Morphine",
            "subtitle": "Oral Tablet (IR)",
            "route": "PO",
            "mmeFactor": 1.0,
            "pkProfile": {
                "onset": "30-60 min",
                "peak": "60 min",
                "duration": "4 hrs",
                "bioavailability": "25-35%"
            },
            "safetyProfile": {
                "renalNote": "Active metabolites (M3G/M6G) accumulate in renal failure. M6G is potent/neurotoxic.",
                "boxedWarning": "Respiratory Depression"
            },
            "citations": [
                "FDA Label 2024",
                "CDC 2022",
                "Berger 2024"
            ]
        },
        "hydromorphone_iv": {
            "familyId": "hydromorphone_generic",
            "name": "Hydromorphone",
            "subtitle": "Injectable (IV/SQ/IM)",
            "route": "IV",
            "mmeFactor": 20.0,
            "pkProfile": {
                "onset": "5 min",
                "peak": "10-20 min",
                "duration": "2-4 hrs",
                "bioavailability": null
            },
            "safetyProfile": {
                "renalNote": "Safer than Morphine. Accumulation of H3G (Neuroexcitatory) in failure.",
                "boxedWarning": "Respiratory Depression"
            },
            "citations": [
                "FDA Label 2024",
                "NCCN 2025"
            ]
        },
        "hydromorphone_po_ir": {
            "familyId": "hydromorphone_generic",
            "name": "Hydromorphone",
            "subtitle": "Oral Tablet (IR)",
            "route": "PO",
            "mmeFactor": 4.0,
            "pkProfile": {
                "onset": "15-30 min",
                "peak": "30-60 min",
                "duration": "3-4 hrs",
                "bioavailability": "62%"
            },
            "safetyProfile": {
                "renalNote": "H3G Accumulation Risk (Neuroexcitatory/Seizures).",
                "boxedWarning": "High Potency - Check Dose"
            },
            "citations": [
                "FDA Label 2024"
            ]
        },
        "oxycodone_po_ir": {
            "familyId": "oxycodone_generic",
            "name": "Oxycodone",
            "subtitle": "Oral Tablet (IR)",
            "route": "PO",
            "mmeFactor": 1.5,
            "pkProfile": {
                "onset": "10-15 min",
                "peak": "30-60 min",
                "duration": "3-6 hrs",
                "bioavailability": "60-87%"
            },
            "safetyProfile": {
                "renalNote": "Active metabolites (Noroxycodone). Use caution in impairment.",
                "boxedWarning": "Addiction, Abuse, and Misuse"
            },
            "citations": [
                "FDA Label 2024",
                "CDC 2022"
            ]
        },
        "fentanyl_iv": {
            "familyId": "fentanyl_generic",
            "name": "Fentanyl",
            "subtitle": "Injectable (IV)",
            "route": "IV",
            "mmeFactor": 0.13,
            "pkProfile": {
                "onset": "Immediate",
                "peak": "3-5 min",
                "duration": "0.5-1 hr",
                "bioavailability": null
            },
            "safetyProfile": {
                "renalNote": "Appears safe. Inactive metabolites.",
                "boxedWarning": "Life-Threatening Respiratory Depression"
            },
            "citations": [
                "FDA Label 2024",
                "NCCN 2025"
            ]
        },
        "fentanyl_patch": {
            "familyId": "fentanyl_generic",
            "name": "Fentanyl",
            "subtitle": "Transdermal Patch",
            "route": "PATCH",
            "mmeFactor": 2.4,
            "pkProfile": {
                "onset": "12-24 hrs (Delayed)",
                "peak": "20-72 hrs",
                "duration": "72 hrs",
                "bioavailability": "92%"
            },
            "safetyProfile": {
                "renalNote": "Safe, but difficult to titrate in unstable patients.",
                "boxedWarning": "FATAL in Opioid Naive. Heat increases absorption."
            },
            "citations": [
                "FDA Label 2024",
                "CDC 2022"
            ]
        },
        "methadone_iv": {
            "familyId": "methadone_generic",
            "name": "Methadone",
            "subtitle": "Injectable (IV)",
            "route": "IV",
            "mmeFactor": 4.7,
            "pkProfile": {
                "onset": "10-20 min",
                "peak": "30-60 min",
                "duration": "Variable (4-8 hrs Analgesia)",
                "bioavailability": null
            },
            "safetyProfile": {
                "renalNote": "Safe (Fecal excretion). Watch for QT Prolongation.",
                "boxedWarning": "QT Prolongation & Torsades de Pointes"
            },
            "citations": [
                "FDA Label 2024",
                "ASAM 2020"
            ]
        },
        "methadone_po": {
            "familyId": "methadone_generic",
            "name": "Methadone",
            "subtitle": "Oral Tablet",
            "route": "PO",
            "mmeFactor": 4.7,
            "pkProfile": {
                "onset": "30-60 min",
                "peak": "1-3 hrs",
                "duration": "Variable (4-8 hrs Analgesia)",
                "bioavailability": "80-100%"
            },
            "safetyProfile": {
                "renalNote": "Safe (Fecal excretion). Watch for QT Prolongation.",
                "boxedWarning": "QT Prolongation & Respiratory Depression (Late Onset)"
            },
            "citations": [
                "FDA Label 2024",
                "ASAM 2020"
            ]
        }
    },
    "conversionFactors": {
        "fentanyl": {
            "routes": [
                {
                    "route": "iv_acute",
                    "factor": 0.3,
                    "unit": "mcg/day",
                    "evidenceQuality": "high",
                    "source": "FDA Label + NCCN 2025",
                    "citation": "100 mcg IV fentanyl = 10 mg IV morphine (single-dose)",
                    "clinicalContext": "For bolus dosing, PRN administration, or short-duration infusions."
                },
                {
                    "route": "iv_continuous",
                    "factor": 0.12,
                    "unit": "mcg/day",
                    "evidenceQuality": "moderate",
                    "source": "NCCN 2025",
                    "citation": "Steady-state ratio 250 mcg IV fentanyl = 10 mg IV morphine",
                    "clinicalContext": "For continuous infusions >24 hours. Accounts for accumulation and context-sensitive half-life.",
                    "temporalThreshold": "24 hours",
                    "pharmacokineticRationale": "Fentanyl accumulates in skeletal muscle and fat (Vd 6 L/kg). Terminal tÂ½ 219 minutes. Steady-state reached after ~5 half-lives (18 hours)."
                },
                {
                    "route": "transdermal",
                    "factor": 2.4,
                    "unit": "mcg/hr",
                    "evidenceQuality": "high",
                    "source": "CDC 2022",
                    "citation": "25mcg/hr Fentanyl â‰ˆ 60 MME",
                    "warnings": [
                        "DANGER: Do not use in Opioid Naive patients",
                        "Patches have delayed onset (12-24h) and offset",
                        "Absorption increased by heat (fever, heating pads) - RISK OF OVERDOSE (CDC 2022)",
                        "Cachexia: Poor absorption in patients with little subcutaneous fat"
                    ],
                    "clinicalContext": "EAPC recommends 100:1 ratio (Oral Morphine:Transdermal Fentanyl). ONLY for Opioid Tolerant patients (FDA: 60mg MS, 30mg Oxy, 8mg Hydro, 25mcg Fent for â‰¥1 week)."
                }
            ]
        },
        "hydromorphone": {
            "routes": [
                {
                    "route": "iv",
                    "factor": 20.0,
                    "unit": "mg/day",
                    "evidenceQuality": "moderate",
                    "source": "NCCN 2025 / Clinical Standard",
                    "citation": "1.5mg IV HM = 10mg IV MS = 30mg PO MS (Ratio 20:1)",
                    "clinicalContext": "Factor 20.0 aligns with standard equianalgesic table. 1.5mg IV Dilaudid is approx 30 MME. Previous factor (6.7) was too conservative."
                },
                {
                    "route": "po",
                    "factor": 4.0,
                    "unit": "mg/day",
                    "evidenceQuality": "high",
                    "source": "CDC 2022",
                    "citation": "Standard 1:4 ratio (7.5mg HM = 30 MME)",
                    "clinicalContext": "Standard oral conversion."
                },
                {
                    "route": "iv_continuous",
                    "factor": 20.0,
                    "unit": "mg/day",
                    "evidenceQuality": "moderate",
                    "source": "Clinical Estimate",
                    "citation": "Same as IV Push.",
                    "clinicalContext": "Continuous infusion."
                }
            ]
        },
        "morphine_iv": {
            "routes": [
                {
                    "route": "iv",
                    "factor": 3.0,
                    "unit": "mg/day",
                    "evidenceQuality": "high",
                    "source": "CDC 2022 / Mercadante 2010",
                    "citation": "Chronic dosing ratio 1:3 (IV:PO)",
                    "clinicalContext": "Standard chronic ratio (1:3). Acute rotation often uses 1:6 ratio due to incomplete cross-tolerance. Mercadante 2010 supports 1:2.5-1:3 for chronic."
                },
                {
                    "route": "iv_continuous",
                    "factor": 3.0,
                    "unit": "mg/day",
                    "evidenceQuality": "high",
                    "source": "CDC 2022",
                    "citation": "Reference Standard (1 mg = 1 MME)",
                    "clinicalContext": "Continuous infusion."
                }
            ]
        },
        "morphine_po_ir": {
            "routes": [
                {
                    "route": "po",
                    "factor": 1.0,
                    "unit": "mg/day",
                    "evidenceQuality": "high",
                    "source": "CDC 2022",
                    "citation": "Reference Standard (1 mg = 1 MME)",
                    "clinicalContext": "Reference Standard."
                }
            ]
        },
        "methadone": {
            "routes": [
                {
                    "route": "po",
                    "factor": 4.7,
                    "unit": "mg/day",
                    "evidenceQuality": "low",
                    "source": "CDC 2022",
                    "citation": "CDC conversion factor for MME calculation only. NOT for dose conversion.",
                    "clinicalContext": "FOR RISK STRATIFICATION ONLY. Methadone conversion is non-linear and dose-dependent (ratios 2:1 to 20:1). When converting TO methadone, use tiered ratios.",
                    "warnings": [
                        "NON-LINEAR: Conversion ratio changes with dose",
                        "DO NOT use this factor to convert FROM methadone to other opioids",
                        "Risk Stratification ONLY"
                    ]
                },
                {
                    "route": "iv",
                    "factor": 4.7,
                    "unit": "mg/day",
                    "evidenceQuality": "low",
                    "source": "Clinical Estimate",
                    "citation": "Using conservative PO factor (bioavailability ~80%).",
                    "clinicalContext": "IV Methadone is roughly equipotent to PO. Used conservative estimate.",
                    "warnings": [
                        "HIGH VARIABILITY",
                        "Risk Stratification ONLY"
                    ]
                }
            ]
        },
        "oxycodone": {
            "routes": [
                {
                    "route": "po",
                    "factor": 1.5,
                    "unit": "mg/day",
                    "evidenceQuality": "high",
                    "source": "CDC 2022",
                    "citation": "Standard 1.5:1 ratio",
                    "clinicalContext": "Consistent across guidelines."
                }
            ]
        },
        "oxymorphone": {
            "routes": [
                {
                    "route": "po",
                    "factor": 3.0,
                    "unit": "mg/day",
                    "evidenceQuality": "moderate",
                    "source": "FDA Label",
                    "citation": "Approximately 3x potency of oral morphine",
                    "clinicalContext": "Potent mu-agonist. 10mg Oral Oxymorphone â‰ˆ 30mg Oral Morphine."
                },
                {
                    "route": "iv",
                    "factor": 30.0,
                    "unit": "mg/day",
                    "evidenceQuality": "low",
                    "source": "Clinical Estimate",
                    "citation": "Estimated 10:1 IV:PO ratio (1mg IV â‰ˆ 10mg PO â‰ˆ 30mg Morphine)",
                    "clinicalContext": "Use extreme caution. IV formulation rarely used."
                }
            ]
        },
        "tramadol": {
            "routes": [
                {
                    "route": "po",
                    "factor": 0.2,
                    "unit": "mg/day",
                    "evidenceQuality": "moderate",
                    "source": "CDC 2022",
                    "citation": "100mg Tramadol â‰ˆ 20 MME",
                    "warnings": [
                        "Seizure risk >400mg/day",
                        "Serotonin Syndrome risk"
                    ],
                    "clinicalContext": "Dual mechanism (Mu-opioid + SNRI). Factor 0.1-0.2 used variably; CDC 2022 uses 0.2."
                }
            ]
        },
        "codeine": {
            "routes": [
                {
                    "route": "po",
                    "factor": 0.15,
                    "unit": "mg/day",
                    "evidenceQuality": "moderate",
                    "source": "CDC 2022",
                    "citation": "200mg Codeine â‰ˆ 30 MME",
                    "clinicalContext": "Prodrug requiring CYP2D6 metabolism. Genetic variability affects efficacy."
                }
            ]
        },
        "tapentadol": {
            "routes": [
                {
                    "route": "po",
                    "factor": 0.4,
                    "unit": "mg/day",
                    "evidenceQuality": "moderate",
                    "source": "Manufacturer / CDC",
                    "citation": "100mg Tapentadol â‰ˆ 40 MME",
                    "clinicalContext": "Dual mechanism (Mu-opioid + NRI). Lower GI side effect profile."
                }
            ]
        },
        "hydrocodone": {
            "routes": [
                {
                    "route": "po",
                    "factor": 1.0,
                    "unit": "mg/day",
                    "evidenceQuality": "high",
                    "source": "CDC 2022",
                    "citation": "1:1 conversion with Morphine",
                    "clinicalContext": "Standard 1:1 ratio. WARNING: Available only in combination with Acetaminophen (APAP) or Ibuprofen. Limit APAP < 4000mg/day (FDA limited tablets to 325mg APAP)."
                }
            ]
        },
        "suzetrigine": {
            "routes": [
                {
                    "route": "po",
                    "factor": 0.0,
                    "unit": "mg/day",
                    "evidenceQuality": "high",
                    "source": "FDA Label (VX-548)",
                    "citation": "Non-Opioid NaV1.8 Inhibitor. Zero MME.",
                    "warnings": [
                        "Non-Opioid: Do not use for withdrawal management",
                        "Renal: Avoid in eGFR < 15 or Dialysis"
                    ],
                    "clinicalContext": "First-in-class NaV1.8 Inhibitor. Indicated for moderate-to-severe acute pain. No physical dependence risk."
                }
            ]
        },
        "levorphanol": {
            "routes": [
                {
                    "route": "po",
                    "factor": 8.0,
                    "unit": "mg/day",
                    "evidenceQuality": "moderate",
                    "source": "FDA Label 2026",
                    "citation": "4-8x potency of morphine (Used upper limit 8x).",
                    "warnings": [
                        "Long half-life (11-16h)",
                        "Accumulation risk similar to methadone"
                    ],
                    "clinicalContext": "Potent NMDA antagonist properties. Used for refractory pain."
                }
            ]
        },
        "meperidine": {
            "routes": [
                {
                    "route": "po",
                    "factor": 0.1,
                    "unit": "mg/day",
                    "evidenceQuality": "low",
                    "source": "Legacy / Equianalgesic Tables",
                    "citation": "300mg Meperidine â‰ˆ 30mg Morphine",
                    "warnings": [
                        "NOT RECOMMENDED for chronic pain",
                        "Neurotoxic metabolite (Normeperidine)",
                        "Seizure risk",
                        "Serotonin Syndrome",
                        "Avoid in elderly/renal failure",
                        "Oral efficacy significantly less than parenteral (Variable)"
                    ],
                    "clinicalContext": "NOT RECOMMENDED. Poor oral bioavailability (<50%). MME factor (0.1) likely OVERESTIMATES potency; use caution when rotating FROM Meperidine (risk of overdosing new drug)."
                },
                {
                    "route": "iv",
                    "factor": 0.4,
                    "unit": "mg/day",
                    "evidenceQuality": "low",
                    "source": "Legacy",
                    "citation": "75mg IV Meperidine â‰ˆ 30mg Morphine",
                    "clinicalContext": "Short duration. Neurotoxic risk remains."
                }
            ]
        },
        "buprenorphine": {
            "routes": [
                {
                    "route": "transdermal",
                    "factor": 0.0,
                    "unit": "mcg/hr",
                    "evidenceQuality": "high",
                    "source": "CDC 2022",
                    "citation": "Excluded from MME calculation due to partial agonism and ceiling effect (CDC 2022).",
                    "warnings": [
                        "Partial Agonist: Ceiling effect on respiratory depression & analgesia",
                        "Precipitated Withdrawal risk if full agonist on board",
                        "QT Prolongation risk >20mcg/hr (FDA warning context: risk mainly at supratherapeutic >40mcg)",
                        "NIH HEAL 2025: Calculator excludes by default but acknowledges emerging role in pain analysis"
                    ],
                    "clinicalContext": "Use cautiously. Not suitable for acute pain MME conversion. NIH HEAL 2025 calculator allows optional analysis."
                },
                {
                    "route": "sl",
                    "factor": 0.0,
                    "unit": "mg",
                    "evidenceQuality": "high",
                    "source": "CDC 2022",
                    "citation": "Excluded from MME calculations",
                    "warnings": [
                        "Partial Agonist - MME not applicable"
                    ],
                    "clinicalContext": "Sublingual bioavailability widely variable."
                }
            ]
        },
        "sufentanil": {
            "routes": [
                {
                    "route": "iv",
                    "factor": 1.0,
                    "unit": "mcg",
                    "evidenceQuality": "low",
                    "source": "Anesthesia Textbooks",
                    "citation": "500-1000x potency of morphine. (1 mcg Suf = 1 mg Morphine)",
                    "warnings": [
                        "Potent Anesthetic",
                        "ICU/OR Setting Only"
                    ],
                    "clinicalContext": "Extreme potency. Not for general ward use."
                }
            ]
        },
        "alfentanil": {
            "routes": [
                {
                    "route": "iv",
                    "factor": 0.02,
                    "unit": "mcg",
                    "evidenceQuality": "low",
                    "source": "Anesthesia Textbooks",
                    "citation": "10-20x potency of morphine (1 mcg Alf = 0.02 mg Morphine)",
                    "warnings": [
                        "Short duration",
                        "ICU/OR Setting Only"
                    ],
                    "clinicalContext": "Rapid onset/offset. Factor derived from 15x Morphine potency."
                }
            ]
        }
    }
}
